<%- include ('../../Partials/headerStyle.ejs'); %>
<link rel="stylesheet" type="text/css" href="../../../app-assets/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="../../../app-assets/css/bootstrap-extended.css">
<link rel="stylesheet" type="text/css" href="../../../app-assets/css/colors.css">
<link rel="stylesheet" type="text/css" href="../../../app-assets/css/components.css">

<body
    class="vertical-layout vertical-menu-modern dark-layout 1-column  navbar-floating footer-static bg-full-screen-image  blank-page blank-page"
    data-open="click" data-menu="vertical-menu-modern" data-col="1-column" data-layout="dark-layout">
    <!-- BEGIN: Content-->
    <div class="app-content content">
        <div class="content-overlay"></div>
        <div class="header-navbar-shadow"></div>
        <div class="content-wrapper">
            <div class="content-header row">
            </div>
            <div class="content-body">
                <section class="row flexbox-container">
                    <div class="col-xl-7 col-10 d-flex justify-content-center">
                        <div class="card rounded-0 mb-0 w-100" style="filter: drop-shadow(2px 4px 6px black);">
                            <div class="row m-0">
                                <div class="col-lg-6 d-lg-block d-none text-center align-self-center p-0">
                                    <img src="../../../app-assets/images/pages/reset-password.png" alt="branding logo">
                                </div>
                                <div class="col-lg-6 col-12 p-0">
                                    <div class="card rounded-0 mb-0 px-2">
                                        <div class="card-header pb-1">
                                            <div class="card-title">
                                                <h4 class="mb-0">Redefinir Senha</h4>
                                            </div>
                                        </div>
                                        <p class="px-2">Digite sua nova senha</p>
                                        <div class="card-content">
                                            <div class="card-body pt-1">
                                                <form novalidate id="reset_password_form" name="reset_password_form">
                                                    <fieldset class="form-label-group">
                                                        <input type="text" class="form-control" id="user-email"
                                                            name="user-email" placeholder="loftera@outlook.com" required
                                                            disabled>
                                                        <label for="user-email">E-mail</label>
                                                    </fieldset>

                                                    <fieldset class="form-label-group">
                                                        <input type="password" class="form-control" id="newPassword"
                                                            name="newPassword" placeholder="Nova Senha" required>
                                                        <label for="user-password">Nova Senha</label>
                                                    </fieldset>

                                                    <fieldset class="form-label-group">
                                                        <input type="password" class="form-control" id="confPassword"
                                                            name="confPassword" placeholder="Confirmar Nova Senha"
                                                            required>
                                                        <label for="user-confirm-password">Confirmar Nova Senha</label>
                                                    </fieldset>
                                                    <div class="row pt-2">
                                                        <div class="col-12 col-md-6 mb-1">
                                                            <a href="/auth-login"
                                                                class="btn btn-outline-primary btn-block px-0">Login</a>
                                                        </div>
                                                        <div class="col-12 col-md-6 mb-1">
                                                            <button type="button" id="changePassword"
                                                                name="changePassword"
                                                                class="btn btn-primary btn-block px-0">Alterar
                                                                Senha</button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </div>

    <script src="../../../app-assets/vendors/js/vendors.min.js"></script>

    <script src="../../../app-assets/js/core/app-menu.js"></script>
    <script src="../../../app-assets/js/core/app.js"></script>
    <script src="../../../app-assets/js/scripts/components.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.js"></script>
    <script src="../../../app-assets/js/scripts/jquery.mask.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <script type="text/javascript">

        function notificacao(confirmButton, modal_color, icon, message) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: confirmButton,
                timer: 3000,
                timerProgressBar: true,
                background: modal_color,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            })

            Toast.fire({
                icon: icon,
                title: message
            })
        }

        $("#changePassword").click(function (e) {
            console.log('click')
            e.preventDefault();
            $("#reset_password_form").validate({
                rules: {
                    newPassword: {
                        required: true,
                        minlength: 8
                    },
                    confPassword: {
                        required: true,
                        equalTo: "#newPassword"
                    }
                },
                messages: {
                    newPassword: {
                        required: "O campo senha é obrigatório",
                        minLength: "O campo senha deve ter pelo menos 8 caracteres."
                    },
                    confPassword: {
                        required: "O campo confirmação de senha é obrigatório.",
                        equalTo: "O campo confirmação de senha deve ser idêntico ao campo senha."
                    }
                }
            });
            if (!$("#reset_password_form").valid()) {
                return;
            } else {
                console.log('else')
                //debugger;
                edit_user_password();
            }
        })

        function edit_user_password() {
            //debugger;
            let user = JSON.parse(localStorage.getItem("currentPasswordChange"));
            let site = "http://localhost:3000/usersp/" + user.id;
            $.ajax({
                type: 'put',
                url: site,
                data: JSON.stringify({
                    newPassword: $("#newPassword").val(),
                    answer: user.answer
                }),
                dataType: "json",
                contentType: "application/json",
                success: function (retorno) {
                    console.log('success', retorno);
                    notificacao(false, '#626262', 'success', 'Senha Alterada')
                    let site = "http://localhost:3000/user/" + user.id;

                    $.ajax({
                        type: 'get',
                        url: site,
                        dataType: "json",
                        contentType: "application/json",
                        success: function (retorno) {
                            console.log('success', retorno);
                            localStorage.setItem("currentUser", JSON.stringify(retorno.data));
                        },
                        error: function (retorno) {
                            console.log('error', retorno)
                        }
                    })
                    localStorage.removeItem("currentPasswordChange");
                    window.location = "/imoveis";
                },
                error: function (retorno) {
                    console.log('error', retorno)
                    notificacao(false, '#d33', 'error', 'Não foi possível alterar sua senha')
                }
            })
        }

        $(document).ready(function () {
            let user = JSON.parse(localStorage.getItem("currentPasswordChange"));
            $("#user-email").val(user.email);
        })

    </script>

</body>


</html>